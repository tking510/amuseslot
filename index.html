<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° MEGA SLOT ğŸ°</title>
    
    <!-- å‹•çš„ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã®è¨­å®š -->
    <script>
        console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹");
        // ç¾åœ¨ã®URLã‹ã‚‰ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å‹•çš„ã«å–å¾—
        window.basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
        console.log("ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹:", window.basePath);
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            text-align: center;
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            border: 3px solid #0ff;
            position: relative;
            overflow: hidden;
        }

        h1 {
            font-size: 2.5em;
            color: #0ff;
            text-shadow: 0 0 15px #0ff;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .slot-machine {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .reel {
            width: 120px;
            height: 150px;
            background: #222;
            border: 2px solid #555;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: #fff;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .reel-inner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s ease-out; /* ã‚¹ãƒ”ãƒ³ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        .spin-button {
            background: linear-gradient(45deg, #ff6b6b, #ee4c4c);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(255, 107, 107, 0.6);
        }

        .spin-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 5px 10px rgba(255, 107, 107, 0.4);
        }

        .spin-button:disabled {
            background: linear-gradient(45deg, #cccccc, #aaaaaa);
            cursor: not-allowed;
            box-shadow: none;
        }

        .result-display {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #0ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .result-message {
            font-size: 2em;
            font-weight: bold;
            color: #0ff;
            text-shadow: 0 0 10px #0ff;
            margin-bottom: 10px;
        }

        .bonus-code {
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            color: #ff0;
            text-shadow: 0 0 8px #ff0;
            word-break: break-all;
        }

        .info-text {
            margin-top: 20px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        .info-text span {
            color: #0ff;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .slot-machine {
                flex-direction: column;
                align-items: center;
            }

            .reel {
                width: 100px;
                height: 120px;
                font-size: 2.5em;
            }

            .spin-button {
                font-size: 1.5em;
                padding: 12px 30px;
            }

            .result-message {
                font-size: 1.5em;
            }

            .bonus-code {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>MEGA SLOT</h1>
        <div class="slot-machine" id="slotMachine">
            <div class="reel"><div class="reel-inner" id="reel1">ğŸ’</div></div>
            <div class="reel"><div class="reel-inner" id="reel2">ğŸ’</div></div>
            <div class="reel"><div class="reel-inner" id="reel3">ğŸ’</div></div>
        </div>
        <button class="spin-button" id="spinButton">ğŸ² SPIN ğŸ²</button>
        <div class="result-display">
            <div class="result-message" id="resultMessage"></div>
            <div class="bonus-code" id="bonusCode"></div>
        </div>
        <p class="info-text">
            <span>ğŸ€ é‹è©¦ã—ã‚’ã—ã¦ã¿ã‚ˆã†ï¼ ğŸ€</span><br>
            ç‰¹åˆ¥ãªã‚³ãƒ¼ãƒ‰ã‚’ã‚²ãƒƒãƒˆã—ã¦ãŠå¾—ãªç‰¹å…¸ã‚’å—ã‘å–ã‚ã†ï¼
        </p>
    </div>

    <script src="game-manager.js"></script>
    <script>
        const reels = [
            document.getElementById('reel1'),
            document.getElementById('reel2'),
            document.getElementById('reel3')
        ];
        const spinButton = document.getElementById('spinButton');
        const resultMessage = document.getElementById('resultMessage');
        const bonusCodeDisplay = document.getElementById('bonusCode');

        let spinning = false;

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', async () => {
            await gameManager.loadConfig(); // config.jsonã‚’èª­ã¿è¾¼ã‚€
            updateSpinButtonState();
            console.log("ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†");
        });

        // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateSpinButtonState() {
            if (gameManager.hasPlayed()) {
                spinButton.disabled = true;
                spinButton.textContent = 'æœ¬æ—¥ã¯ãƒ—ãƒ¬ã‚¤æ¸ˆã¿ã§ã™';
                spinButton.style.background = 'linear-gradient(45deg, #cccccc, #aaaaaa)';
                resultMessage.textContent = 'ã¾ãŸæ˜æ—¥ãŠè¶Šã—ãã ã•ã„ï¼';
                bonusCodeDisplay.textContent = '';
            } else {
                spinButton.disabled = false;
                spinButton.textContent = 'ğŸ² SPIN ğŸ²';
                spinButton.style.background = 'linear-gradient(45deg, #ff6b6b, #ee4c4c)';
                resultMessage.textContent = '';
                bonusCodeDisplay.textContent = '';
            }
        }

        spinButton.addEventListener('click', async () => {
            if (spinning || gameManager.hasPlayed()) return;

            spinning = true;
            spinButton.disabled = true;
            resultMessage.textContent = '';
            bonusCodeDisplay.textContent = '';

            const symbols = gameManager.config.symbols;
            const spinDuration = gameManager.config.gameSettings.spinDuration;
            const reelStopDelay = gameManager.config.gameSettings.reelStopDelay;
            const animationSpeed = gameManager.config.gameSettings.animationSpeed;

            // å„ãƒªãƒ¼ãƒ«ã®ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const spinPromises = reels.map((reel, index) => {
                return new Promise(resolve => {
                    let animationInterval;
                    let position = 0;
                    const symbolHeight = reel.clientHeight; // ãƒªãƒ¼ãƒ«ã®é«˜ã•

                    animationInterval = setInterval(() => {
                        position -= animationSpeed; // ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        if (position <= -symbolHeight) {
                            position = 0; // ä¸€ç•ªä¸Šã¾ã§è¡Œã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                            // ã‚·ãƒ³ãƒœãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ›´æ–°
                            reel.querySelector('.reel-inner').textContent = symbols[Math.floor(Math.random() * symbols.length)];
                        }
                        reel.querySelector('.reel-inner').style.transform = `translateY(${position}px)`;
                    }, 50);

                    setTimeout(() => {
                        clearInterval(animationInterval);
                        resolve();
                    }, spinDuration + (reelStopDelay * index));
                });
            });

            await Promise.all(spinPromises);

            // çµæœã®æ±ºå®šã¨è¡¨ç¤º
            const resultType = gameManager.determineResult();
            const generatedCode = gameManager.generateCode(resultType);
            gameManager.updateStatistics(resultType, generatedCode);
            gameManager.setPlayed(); // ãƒ—ãƒ¬ã‚¤æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š

            const winPattern = gameManager.config.winPatterns[resultType];
            resultMessage.textContent = winPattern.message;
            bonusCodeDisplay.textContent = `ã‚³ãƒ¼ãƒ‰: ${generatedCode}`;

            // æœ€çµ‚çš„ãªã‚·ãƒ³ãƒœãƒ«ã®è¡¨ç¤ºï¼ˆçµæœã«å¿œã˜ã¦ï¼‰
            const finalSymbols = getFinalSymbols(resultType);
            reels.forEach((reel, index) => {
                reel.querySelector('.reel-inner').textContent = finalSymbols[index];
                reel.querySelector('.reel-inner').style.transform = 'translateY(0)'; // ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
            });

            spinning = false;
            updateSpinButtonState(); // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        });

        // çµæœã«å¿œã˜ãŸæœ€çµ‚ã‚·ãƒ³ãƒœãƒ«ã‚’æ±ºå®š
        function getFinalSymbols(resultType) {
            const symbols = gameManager.config.symbols;
            const jackpotSymbol = '7ï¸âƒ£'; // ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆã®ã‚·ãƒ³ãƒœãƒ«
            const bigWinSymbol = 'ğŸ’'; // ãƒ“ãƒƒã‚°ã‚¦ã‚£ãƒ³ã®ã‚·ãƒ³ãƒœãƒ«
            const smallWinSymbol = 'â­'; // ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¦ã‚£ãƒ³ã®ã‚·ãƒ³ãƒœãƒ«

            switch (resultType) {
                case 'jackpot':
                    return [jackpotSymbol, jackpotSymbol, jackpotSymbol];
                case 'bigWin':
                    // 2ã¤åŒã˜ã‚·ãƒ³ãƒœãƒ« + 1ã¤ãƒ©ãƒ³ãƒ€ãƒ 
                    const commonSymbolBW = bigWinSymbol;
                    const randomSymbolBW = symbols.filter(s => s !== commonSymbolBW)[Math.floor(Math.random() * (symbols.length - 1))];
                    const bigWinArr = [commonSymbolBW, commonSymbolBW, randomSymbolBW];
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆ
                    for (let i = bigWinArr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [bigWinArr[i], bigWinArr[j]] = [bigWinArr[j], bigWinArr[i]];
                    }
                    return bigWinArr;
                case 'smallWin':
                    // 2ã¤åŒã˜ã‚·ãƒ³ãƒœãƒ« + 1ã¤ãƒ©ãƒ³ãƒ€ãƒ 
                    const commonSymbolSW = smallWinSymbol;
                    const randomSymbolSW = symbols.filter(s => s !== commonSymbolSW)[Math.floor(Math.random() * (symbols.length - 1))];
                    const smallWinArr = [commonSymbolSW, commonSymbolSW, randomSymbolSW];
                    // ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆ
                    for (let i = smallWinArr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [smallWinArr[i], smallWinArr[j]] = [smallWinArr[j], smallWinArr[i]];
                    }
                    return smallWinArr;
                case 'lose':
                default:
                    // å…¨ã¦ç•°ãªã‚‹ã‚·ãƒ³ãƒœãƒ«
                    let loseSymbols = [];
                    while (loseSymbols.length < 3) {
                        const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                        if (!loseSymbols.includes(randomSymbol)) {
                            loseSymbols.push(randomSymbol);
                        }
                    }
                    return loseSymbols;
            }
        }
    </script>
</body>
</html>
