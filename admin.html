<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ ç®¡ç†ç”»é¢</title>
    
    <!-- å‹•çš„ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã®è¨­å®š -->
    <script>
        console.log("ç®¡ç†ç”»é¢èª­ã¿è¾¼ã¿é–‹å§‹");
        // ç¾åœ¨ã®URLã‹ã‚‰ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å‹•çš„ã«å–å¾—
        window.basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
        console.log("ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹:", window.basePath);
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .probability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .probability-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        input[type="number"], input[type="text"], input[type="file"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .code-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .tab-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            color: #666;
        }

        .game-preview {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: #3498db;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .pattern-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .pattern-selector select {
            flex-grow: 1;
            max-width: 300px;
        }

        .pattern-management {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .pattern-management h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .pattern-management input[type="text"] {
            margin-bottom: 10px;
        }

        .logo-upload-preview {
            margin-top: 15px;
            text-align: center;
        }

        .logo-upload-preview img {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .probability-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .section {
                padding: 15px;
            }

            .pattern-selector {
                flex-direction: column;
                align-items: flex-start;
            }

            .pattern-selector select {
                max-width: 100%;
            }
        }
    </style>
    
    <!-- game-manager.jsã®èª­ã¿è¾¼ã¿ -->
    <script src="./game-manager.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° ã‚¹ãƒ­ãƒƒãƒˆã‚²ãƒ¼ãƒ ç®¡ç†ç”»é¢</h1>
            <p>ç¢ºç‡è¨­å®šãƒ»çµ±è¨ˆç®¡ç†ãƒ»ã‚³ãƒ¼ãƒ‰å±¥æ­´</p>
        </div>

        <div class="content">
            <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ›ï¸ ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç†</h2>
                <div id="patternAlert"></div>
                <div class="pattern-selector">
                    <label for="patternSelect">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‘ã‚¿ãƒ¼ãƒ³:</label>
                    <select id="patternSelect"></select>
                    <button id="activatePattern" class="btn-primary">ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–</button>
                    <button id="addPatternBtn" class="btn-success">æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ </button>
                    <button id="deletePatternBtn" class="btn-danger">é¸æŠã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
                </div>

                <div class="pattern-management">
                    <h3>æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ </h3>
                    <label for="newPatternId">æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ID (åŠè§’è‹±æ•°å­—):</label>
                    <input type="text" id="newPatternId" placeholder="ä¾‹: pattern_high_jp">
                    <button id="createNewPattern" class="btn-primary">ä½œæˆ</button>
                </div>
            </div>

            <!-- ç¢ºç‡è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âš™ï¸ ç¢ºç‡è¨­å®š</h2>
                <div id="probabilityAlert"></div>
                
                <div class="probability-grid">
                    <div class="probability-item">
                        <label for="jackpotProb">ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆç¢ºç‡ (%)</label>
                        <input type="number" id="jackpotProb" min="0" max="100" step="0.1">
                    </div>
                    
                    <div class="probability-item">
                        <label for="bigWinProb">ãƒ“ãƒƒã‚°ã‚¦ã‚£ãƒ³ç¢ºç‡ (%)</label>
                        <input type="number" id="bigWinProb" min="0" max="100" step="0.1">
                    </div>
                    
                    <div class="probability-item">
                        <label for="smallWinProb">ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¦ã‚£ãƒ³ç¢ºç‡ (%)</label>
                        <input type="number" id="smallWinProb" min="0" max="100" step="0.1">
                    </div>
                    
                    <div class="probability-item">
                        <label for="loseProb">è² ã‘ç¢ºç‡ (%)</label>
                        <input type="number" id="loseProb" min="0" max="100" step="0.1" readonly>
                    </div>
                </div>
                
                <button id="saveProbabilities" class="btn-primary">ç¢ºç‡è¨­å®šã‚’ä¿å­˜</button>
                <button id="resetProbabilities" class="btn-warning">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            </div>

            <!-- ãƒœãƒ¼ãƒŠã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ ãƒœãƒ¼ãƒŠã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®š</h2>
                <div id="bonusCodeAlert"></div>
                <p>å›ºå®šã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã¨ã€ãã®ã‚³ãƒ¼ãƒ‰ãŒå¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ç©ºæ¬„ã«ã™ã‚‹ã¨è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
                <div class="probability-grid">
                    <div class="probability-item">
                        <label for="jackpotCode">ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆå›ºå®šã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="jackpotCode" placeholder="ä¾‹: JP_SPECIAL_CODE">
                    </div>
                    <div class="probability-item">
                        <label for="bigWinCode">ãƒ“ãƒƒã‚°ã‚¦ã‚£ãƒ³å›ºå®šã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="bigWinCode" placeholder="ä¾‹: BW_LUCKY_CODE">
                    </div>
                    <div class="probability-item">
                        <label for="smallWinCode">ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¦ã‚£ãƒ³å›ºå®šã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="smallWinCode" placeholder="ä¾‹: SW_GIFT_CODE">
                    </div>
                </div>
                <button id="saveBonusCodes" class="btn-primary">ãƒœãƒ¼ãƒŠã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜</button>
            </div>

            <!-- ãƒ­ã‚´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ–¼ï¸ ãƒ­ã‚´ç”»åƒè¨­å®š</h2>
                <div id="logoUploadAlert"></div>
                <label for="logoUpload">ãƒ­ã‚´ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (PNG, JPG, GIF):</label>
                <input type="file" id="logoUpload" accept="image/png, image/jpeg, image/gif">
                <button id="uploadLogo" class="btn-primary">ãƒ­ã‚´ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <div class="logo-upload-preview">
                    <p>ç¾åœ¨ã®ãƒ­ã‚´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</p>
                    <img id="currentLogoPreview" src="" alt="ç¾åœ¨ã®ãƒ­ã‚´" style="display: none;">
                </div>
            </div>
            
            <!-- çµ±è¨ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="summary">ã‚µãƒãƒªãƒ¼</button>
                        <button class="tab-button" data-tab="details">è©³ç´°ãƒ‡ãƒ¼ã‚¿</button>
                    </div>
                    
                    <div class="tab-content active" id="summary">
                        <table>
                            <tr>
                                <th>é …ç›®</th>
                                <th>å€¤</th>
                            </tr>
                            <tr>
                                <td>ç·ãƒ—ãƒ¬ã‚¤å›æ•°</td>
                                <td id="totalPlays">0</td>
                            </tr>
                            <tr>
                                <td>ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆå›æ•°</td>
                                <td id="jackpotWins">0</td>
                            </tr>
                            <tr>
                                <td>ãƒ“ãƒƒã‚°ã‚¦ã‚£ãƒ³å›æ•°</td>
                                <td id="bigWins">0</td>
                            </tr>
                            <tr>
                                <td>ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¦ã‚£ãƒ³å›æ•°</td>
                                <td id="smallWins">0</td>
                            </tr>
                            <tr>
                                <td>å‹ç‡</td>
                                <td id="winRate">0%</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="tab-content" id="details">
                        <p>è©³ç´°ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
                
                <button id="resetStats" class="btn-danger">çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <!-- ã‚³ãƒ¼ãƒ‰å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸŸï¸ ã‚³ãƒ¼ãƒ‰å±¥æ­´</h2>
                
                <div class="code-list">
                    <table id="codeTable">
                        <thead>
                            <tr>
                                <th>ã‚³ãƒ¼ãƒ‰</th>
                                <th>ã‚¿ã‚¤ãƒ—</th>
                                <th>æ—¥æ™‚</th>
                                <th>ãƒ‘ã‚¿ãƒ¼ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="codeTableBody">
                            <!-- ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«å…¥ã‚Šã¾ã™ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button id="exportCodes" class="btn-success">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="clearCodes" class="btn-danger">å±¥æ­´ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
            
            <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ® ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                
                <div class="action-buttons">
                    <button id="openGame" class="btn-primary">ã‚²ãƒ¼ãƒ ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</button>
                    <button id="openGameTestMode" class="btn-warning">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚²ãƒ¼ãƒ ã‚’é–‹ã</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>MEGA SLOT ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0</p>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // gameManagerãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
            await gameManager.loadConfig();
            console.log("admin.html: gameManager config loaded", gameManager.config);

            // åˆæœŸè¡¨ç¤ºã®æ›´æ–°
            updatePatternSelector();
            loadCurrentPatternSettings();
            initStatistics();
            initCodeHistory();
            updateLogoPreview();

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            document.getElementById('patternSelect').addEventListener('change', loadCurrentPatternSettings);
            document.getElementById('activatePattern').addEventListener('click', activateSelectedPattern);
            document.getElementById('addPatternBtn').addEventListener('click', showNewPatternInput);
            document.getElementById('createNewPattern').addEventListener('click', createNewPattern);
            document.getElementById('deletePatternBtn').addEventListener('click', deleteSelectedPattern);

            document.getElementById('jackpotProb').addEventListener('input', updateLoseProbability);
            document.getElementById('bigWinProb').addEventListener('input', updateLoseProbability);
            document.getElementById('smallWinProb').addEventListener('input', updateLoseProbability);
            document.getElementById('saveProbabilities').addEventListener('click', saveProbabilities);
            document.getElementById('resetProbabilities').addEventListener('click', resetProbabilities);

            document.getElementById('saveBonusCodes').addEventListener('click', saveBonusCodes);

            document.getElementById('uploadLogo').addEventListener('click', uploadLogo);
            document.getElementById('logoUpload').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('currentLogoPreview').src = e.target.result;
                        document.getElementById('currentLogoPreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById('currentLogoPreview').style.display = 'none';
                }
            });

            document.getElementById('resetStats').addEventListener('click', resetStatistics);
            document.getElementById('exportCodes').addEventListener('click', exportCodesToCSV);
            document.getElementById('clearCodes').addEventListener('click', clearCodeHistory);
            document.getElementById('openGame').addEventListener('click', openGame);
            document.getElementById('openGameTestMode').addEventListener('click', openGameTestMode);

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });

            // --- é–¢æ•°å®šç¾© ---

            // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®æ›´æ–°
            function updatePatternSelector() {
                const patternSelect = document.getElementById('patternSelect');
                patternSelect.innerHTML = '';
                const allPatterns = gameManager.getAllPatterns();
                for (const id in allPatterns) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = id;
                    if (id === gameManager.activePatternId) {
                        option.selected = true;
                    }
                    patternSelect.appendChild(option);
                }
            }

            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
            function loadCurrentPatternSettings() {
                const selectedPatternId = document.getElementById('patternSelect').value;
                if (!selectedPatternId) return;

                const currentConfig = gameManager.config.patterns[selectedPatternId];
                if (currentConfig) {
                    document.getElementById('jackpotProb').value = (currentConfig.probabilities.jackpot * 100).toFixed(1);
                    document.getElementById('bigWinProb').value = (currentConfig.probabilities.bigWin * 100).toFixed(1);
                    document.getElementById('smallWinProb').value = (currentConfig.probabilities.smallWin * 100).toFixed(1);
                    updateLoseProbability(); // è² ã‘ç¢ºç‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º

                    document.getElementById('jackpotCode').value = currentConfig.winPatterns.jackpot.fixedCode || '';
                    document.getElementById('bigWinCode').value = currentConfig.winPatterns.bigWin.fixedCode || '';
                    document.getElementById('smallWinCode').value = currentConfig.winPatterns.smallWin.fixedCode || '';

                    updateLogoPreview(currentConfig.gameSettings.logoUrl);
                }
            }

            // é¸æŠã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            function activateSelectedPattern() {
                const selectedPatternId = document.getElementById('patternSelect').value;
                if (gameManager.setActivePattern(selectedPatternId)) {
                    showAlert('patternAlert', `ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ${selectedPatternId}ã€ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã¾ã—ãŸã€‚`, 'success');
                    // ã‚²ãƒ¼ãƒ ç”»é¢ã®URLã‚’æ›´æ–°
                    updateGameLinks(selectedPatternId);
                } else {
                    showAlert('patternAlert', 'ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
                }
            }

            // æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
            function showNewPatternInput() {
                const newPatternInput = document.getElementById('newPatternId');
                const createButton = document.getElementById('createNewPattern');
                if (newPatternInput.style.display === 'block') {
                    newPatternInput.style.display = 'none';
                    createButton.style.display = 'none';
                } else {
                    newPatternInput.style.display = 'block';
                    createButton.style.display = 'block';
                }
            }

            // æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆ
            function createNewPattern() {
                const newPatternId = document.getElementById('newPatternId').value.trim();
                if (!newPatternId) {
                    showAlert('patternAlert', 'æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
                    return;
                }
                if (!/^[a-zA-Z0-9_]+$/.test(newPatternId)) {
                    showAlert('patternAlert', 'ãƒ‘ã‚¿ãƒ¼ãƒ³IDã¯åŠè§’è‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚', 'danger');
                    return;
                }

                const defaultProbabilities = { jackpot: 0.01, bigWin: 0.05, smallWin: 0.15, lose: 0.79 };
                const defaultWinPatterns = {
                    jackpot: { message: "ğŸ‰ JACKPOT! ğŸ‰", codePrefix: "JP", multiplier: 1000, description: "å…¨ã¦åŒã˜çµµæŸ„", fixedCode: "" },
                    bigWin: { message: "ğŸŠ BIG WIN! ğŸŠ", codePrefix: "BW", multiplier: 100, description: "2ã¤åŒã˜çµµæŸ„", fixedCode: "" },
                    smallWin: { message: "âœ¨ WIN! âœ¨", codePrefix: "SW", multiplier: 10, description: "ç‰¹å®šã®çµ„ã¿åˆã‚ã›", fixedCode: "" },
                    lose: { message: "æ®‹å¿µï¼ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼", codePrefix: "LOSE", multiplier: 0, description: "ãƒã‚ºãƒ¬", fixedCode: "" }
                };
                const defaultSymbols = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‡', 'ğŸ””', 'â­', 'ğŸ’', '7ï¸âƒ£'];
                const defaultGameSettings = { spinDuration: 2000, reelStopDelay: 500, animationSpeed: 20, logoUrl: "" };

                if (gameManager.addProbabilityPattern(newPatternId, defaultProbabilities, defaultWinPatterns, defaultSymbols, defaultGameSettings)) {
                    showAlert('patternAlert', `ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ${newPatternId}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`, 'success');
                    document.getElementById('newPatternId').value = '';
                    updatePatternSelector();
                    document.getElementById('patternSelect').value = newPatternId; // æ–°ã—ãä½œæˆã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    loadCurrentPatternSettings(); // è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
                } else {
                    showAlert('patternAlert', 'ãƒ‘ã‚¿ãƒ¼ãƒ³IDãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚', 'danger');
                }
            }

            // é¸æŠã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤
            function deleteSelectedPattern() {
                const selectedPatternId = document.getElementById('patternSelect').value;
                if (selectedPatternId === 'default') {
                    showAlert('patternAlert', 'ã€Œdefaultã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚', 'danger');
                    return;
                }
                if (confirm(`æœ¬å½“ã«ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ${selectedPatternId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    if (gameManager.deleteProbabilityPattern(selectedPatternId)) {
                        showAlert('patternAlert', `ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ${selectedPatternId}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'success');
                        updatePatternSelector();
                        loadCurrentPatternSettings(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã‚‹ã®ã§ãã®è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
                    } else {
                        showAlert('patternAlert', 'ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
                    }
                }
            }

            // ç¢ºç‡ã®åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´
            function updateLoseProbability() {
                const jackpot = parseFloat(document.getElementById('jackpotProb').value) || 0;
                const bigWin = parseFloat(document.getElementById('bigWinProb').value) || 0;
                const smallWin = parseFloat(document.getElementById('smallWinProb').value) || 0;
                
                let lose = 100 - (jackpot + bigWin + smallWin);
                lose = Math.max(0, lose); // è² ã®å€¤ã«ãªã‚‰ãªã„ã‚ˆã†ã«
                
                document.getElementById('loseProb').value = lose.toFixed(1);
                
                return jackpot + bigWin + smallWin <= 100;
            }
            
            // ç¢ºç‡è¨­å®šã®ä¿å­˜
            function saveProbabilities() {
                if (!updateLoseProbability()) {
                    showAlert('probabilityAlert', 'å‹ç‡ã®åˆè¨ˆãŒ100%ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚èª¿æ•´ã—ã¦ãã ã•ã„ã€‚', 'danger');
                    return;
                }
                
                const jackpot = parseFloat(document.getElementById('jackpotProb').value) / 100;
                const bigWin = parseFloat(document.getElementById('bigWinProb').value) / 100;
                const smallWin = parseFloat(document.getElementById('smallWinProb').value) / 100;
                const lose = parseFloat(document.getElementById('loseProb').value) / 100;
                
                if (typeof gameManager !== 'undefined') {
                    gameManager.updateProbabilities({
                        jackpot,
                        bigWin,
                        smallWin,
                        lose
                    });
                    showAlert('probabilityAlert', 'ç¢ºç‡è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                } else {
                    showAlert('probabilityAlert', 'gameManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
                }
            }
            
            // ç¢ºç‡è¨­å®šã®ãƒªã‚»ãƒƒãƒˆ
            function resetProbabilities() {
                if (typeof gameManager !== 'undefined') {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                    const defaultProbabilities = {
                        jackpot: 0.01,
                        bigWin: 0.05,
                        smallWin: 0.15,
                        lose: 0.79
                    };
                    gameManager.updateProbabilities(defaultProbabilities);
                    loadCurrentPatternSettings(); // UIã‚’æ›´æ–°
                    showAlert('probabilityAlert', 'ç¢ºç‡è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'success');
                } else {
                    showAlert('probabilityAlert', 'gameManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
                }
            }

            // ãƒœãƒ¼ãƒŠã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¿å­˜
            function saveBonusCodes() {
                const jackpotCode = document.getElementById('jackpotCode').value.trim();
                const bigWinCode = document.getElementById('bigWinCode').value.trim();
                const smallWinCode = document.getElementById('smallWinCode').value.trim();

                gameManager.updateBonusCode('jackpot', jackpotCode);
                gameManager.updateBonusCode('bigWin', bigWinCode);
                gameManager.updateBonusCode('smallWin', smallWinCode);
                showAlert('bonusCodeAlert', 'ãƒœãƒ¼ãƒŠã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
            }

            // ãƒ­ã‚´ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            function uploadLogo() {
                const fileInput = document.getElementById('logoUpload');
                const file = fileInput.files[0];
                if (!file) {
                    showAlert('logoUploadAlert', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', 'danger');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    // gameManagerã«base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    gameManager.updateLogoUrl(base64Image);
                    showAlert('logoUploadAlert', 'ãƒ­ã‚´ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
                    updateLogoPreview(base64Image);
                };
                reader.readAsDataURL(file);
            }

            // ãƒ­ã‚´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
            function updateLogoPreview(url) {
                const previewImg = document.getElementById('currentLogoPreview');
                const currentConfig = gameManager.getCurrentConfig();
                const logoUrl = url || (currentConfig && currentConfig.gameSettings ? currentConfig.gameSettings.logoUrl : '');
                
                if (logoUrl) {
                    previewImg.src = logoUrl;
                    previewImg.style.display = 'block';
                } else {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
            }

            // çµ±è¨ˆæƒ…å ±ã®åˆæœŸåŒ–
            function initStatistics() {
                if (typeof gameManager !== 'undefined' && gameManager.statistics) {
                    const stats = gameManager.getStatistics();
                    document.getElementById('totalPlays').textContent = stats.totalSpins;
                    document.getElementById('jackpotWins').textContent = stats.wins.jackpot;
                    document.getElementById('bigWins').textContent = stats.wins.bigWin;
                    document.getElementById('smallWins').textContent = stats.wins.smallWin;
                    document.getElementById('winRate').textContent = stats.winRate;
                }
            }

            // çµ±è¨ˆæƒ…å ±ã®ãƒªã‚»ãƒƒãƒˆ
            function resetStatistics() {
                if (confirm('æœ¬å½“ã«çµ±è¨ˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    gameManager.resetStatistics();
                    initStatistics();
                    showAlert('summary', 'çµ±è¨ˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚', 'success');
                }
            }
            
            // ã‚³ãƒ¼ãƒ‰å±¥æ­´ã®åˆæœŸåŒ–
            function initCodeHistory() {
                if (typeof gameManager !== 'undefined' && gameManager.statistics && gameManager.statistics.codesGenerated) {
                    const tableBody = document.getElementById('codeTableBody');
                    tableBody.innerHTML = '';
                    
                    const codes = gameManager.statistics.codesGenerated;
                    
                    if (codes.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</td>';
                        tableBody.appendChild(row);
                        return;
                    }
                    
                    codes.forEach(code => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${code.code}</td>
                            <td>${code.type}</td>
                            <td>${code.timestamp ? new Date(code.timestamp).toLocaleString() : 'N/A'}</td>
                            <td>${code.pattern || 'default'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            }

            // ã‚³ãƒ¼ãƒ‰å±¥æ­´ã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            function exportCodesToCSV() {
                const codes = gameManager.statistics.codesGenerated;
                if (codes.length === 0) {
                    showAlert('codeTableBody', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'danger');
                    return;
                }

                let csvContent = "ã‚³ãƒ¼ãƒ‰,ã‚¿ã‚¤ãƒ—,æ—¥æ™‚,ãƒ‘ã‚¿ãƒ¼ãƒ³\n";
                codes.forEach(code => {
                    const timestamp = code.timestamp ? new Date(code.timestamp).toLocaleString() : 'N/A';
                    csvContent += `${code.code},${code.type},"${timestamp}",${code.pattern || 'default'}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) { // Feature detection for download attribute
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'slot_game_codes.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                showAlert('codeTableBody', 'ã‚³ãƒ¼ãƒ‰å±¥æ­´ã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'success');
            }

            // ã‚³ãƒ¼ãƒ‰å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
            function clearCodeHistory() {
                if (confirm('æœ¬å½“ã«ã‚³ãƒ¼ãƒ‰å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    gameManager.clearCodeHistory();
                    initCodeHistory();
                    showAlert('codeTableBody', 'ã‚³ãƒ¼ãƒ‰å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'success');
                }
            }
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆã®è¡¨ç¤º
            function showAlert(elementId, message, type) {
                const alertDiv = document.getElementById(elementId);
                if (!alertDiv) { // çµ±è¨ˆã‚¿ãƒ–å†…ã®ã‚¢ãƒ©ãƒ¼ãƒˆç”¨
                    const tabContent = document.querySelector(`.tab-content.active`);
                    if (tabContent) {
                        const newAlertDiv = document.createElement('div');
                        newAlertDiv.id = 'tempAlert';
                        newAlertDiv.className = `alert alert-${type}`;
                        newAlertDiv.textContent = message;
                        tabContent.prepend(newAlertDiv);
                        setTimeout(() => {
                            newAlertDiv.remove();
                        }, 3000);
                    }
                    return;
                }
                alert
